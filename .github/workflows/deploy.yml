name: Deploy to EC2

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"

      - name: Install dependencies
        run: |
          npm install

      - name: Test application
        run: |
          node -e "console.log('âœ… Application test passed')"

      - name: Check if app.js exists
        run: |
          if [ -f "app.js" ]; then
            echo "âœ… app.js found"
          else
            echo "âŒ app.js not found"
            exit 1
          fi

  deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'

    steps:
      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            echo "ğŸš€ Starting deployment..."

            # Navigate to project directory
            cd /home/ec2-user
            echo "ğŸ“ Current directory: $(pwd)"

            # Check if AWS-Node directory exists
            if [ ! -d "AWS-Node" ]; then
              echo "âŒ AWS-Node directory not found. Creating it..."
              mkdir -p AWS-Node
              cd AWS-Node
              git init
              git remote add origin https://github.com/${{ github.repository }}.git
            else
              cd AWS-Node
            fi

            # Backup current version
            echo "ğŸ“¦ Creating backup..."
            cd ..
            if [ -d "AWS-Node" ]; then
              cp -r AWS-Node AWS-Node-backup-$(date +%Y%m%d-%H%M%S)
              echo "âœ… Backup created successfully"
            else
              echo "âš ï¸ No existing AWS-Node directory to backup"
            fi
            cd AWS-Node

            # Pull latest changes
            echo "â¬‡ï¸ Pulling latest changes..."
            echo "ğŸ“ Current directory: $(pwd)"
            echo "ğŸ“ Directory contents: $(ls -la)"

            # Check if this is a git repository
            if [ ! -d ".git" ]; then
              echo "âŒ Not a git repository. Cloning fresh..."
              cd ..
              rm -rf AWS-Node
              git clone https://github.com/${{ github.repository }}.git AWS-Node
              cd AWS-Node
            else
              git pull origin main
            fi

            # Install dependencies
            echo "ğŸ“¦ Installing dependencies..."
            echo "ğŸ“ Current directory: $(pwd)"
            echo "ğŸ“ Directory contents: $(ls -la)"

            # Check if package.json exists
            if [ ! -f "package.json" ]; then
              echo "âŒ package.json not found. Current directory: $(pwd)"
              echo "ğŸ“ Available files: $(ls -la)"
              exit 1
            fi

            npm install

            # Create logs directory with proper permissions
            mkdir -p logs || sudo mkdir -p logs
            chmod 755 logs || sudo chmod 755 logs

            # Test the application locally
            echo "ğŸ§ª Testing application..."
            echo "ğŸ“ Current directory: $(pwd)"
            echo "ğŸ“ Checking for app.js: $(ls -la app.js 2>/dev/null || echo 'app.js not found')"
            node -e "console.log('âœ… Local test passed')"

            # Restart with PM2
            echo "ğŸ”„ Restarting application..."
            echo "ğŸ“ Current directory: $(pwd)"
            echo "ğŸ“ Available files: $(ls -la *.js 2>/dev/null || echo 'No JS files found')"

            if pm2 list | grep -q "Weather-App"; then
              pm2 restart Weather-App
            else
              echo "ğŸš€ Starting new PM2 process..."
              if [ -f "ecosystem.config.js" ]; then
                echo "ğŸ“ Using ecosystem.config.js"
                pm2 start ecosystem.config.js --env production
              elif [ -f "app.js" ]; then
                echo "ğŸ“ Using app.js directly"
                pm2 start app.js --name "Weather-App"
              else
                echo "âŒ No app.js or ecosystem.config.js found!"
                echo "ğŸ“ Available files: $(ls -la)"
                exit 1
              fi
            fi

            # Wait a moment for the app to start
            sleep 5

            # Check if deployment was successful
            echo "ğŸ” Verifying deployment..."
            # Wait a bit more for the app to fully start
            sleep 10

            # Try multiple health check attempts
            for i in {1..3}; do
              echo "ğŸ” Health check attempt $i/3..."
              if curl -f http://localhost:3000/health > /dev/null 2>&1; then
                echo "âœ… Deployment successful!"
                echo "ğŸŒ Application is running at: http://${{ secrets.EC2_HOST }}"
                break
              else
                echo "âš ï¸ Health check attempt $i failed, waiting..."
                sleep 5
              fi
            done

            if ! curl -f http://localhost:3000/health > /dev/null 2>&1; then
              echo "âŒ Deployment failed, rolling back..."
              cd ..
              if [ -d "AWS-Node-backup-*" ]; then
                rm -rf AWS-Node
                mv AWS-Node-backup-* AWS-Node
                cd AWS-Node
                if pm2 list | grep -q "Weather-App"; then
                  pm2 restart Weather-App
                else
                  if [ -f "ecosystem.config.js" ]; then
                    pm2 start ecosystem.config.js --env production
                  else
                    pm2 start app.js --name "Weather-App"
                  fi
                fi
              else
                echo "âš ï¸ No backup found, cannot rollback"
              fi
              echo "ğŸ”„ Rollback completed"
              exit 1
            fi

            # Show PM2 status
            echo "ğŸ“Š PM2 Status:"
            pm2 status

            # Show recent logs
            echo "ğŸ“‹ Recent logs:"
            pm2 logs Weather-App --lines 10

            # Show process info
            echo "ğŸ” Process information:"
            ps aux | grep node
            netstat -tlnp | grep :3000 || echo "No process listening on port 3000"

            # Save PM2 configuration for startup
            pm2 save
            pm2 startup

            echo "ğŸ‰ Deployment completed successfully!"
