name: Deploy to EC2

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"

      - name: Install dependencies
        run: |
          npm install

      - name: Test application
        run: |
          node -e "console.log('âœ… Application test passed')"

      - name: Check if app.js exists
        run: |
          if [ -f "app.js" ]; then
            echo "âœ… app.js found"
          else
            echo "âŒ app.js not found"
            exit 1
          fi

  deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'

    steps:
      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            echo "ğŸš€ Starting deployment..."

            # Navigate to project directory
            cd /home/ec2-user/AWS-Node

            # Backup current version
            echo "ğŸ“¦ Creating backup..."
            cd ..
            cp -r AWS-Node AWS-Node-backup-$(date +%Y%m%d-%H%M%S)
            cd AWS-Node

            # Pull latest changes
            echo "â¬‡ï¸ Pulling latest changes..."
            git pull origin main

            # Install dependencies
            echo "ğŸ“¦ Installing dependencies..."
            npm install

            # Create logs directory
            mkdir -p logs

            # Test the application locally
            echo "ğŸ§ª Testing application..."
            node -e "console.log('âœ… Local test passed')"

            # Restart with PM2
            echo "ğŸ”„ Restarting application..."
            if pm2 list | grep -q "Weather-App"; then
              pm2 restart Weather-App
            else
              echo "ğŸš€ Starting new PM2 process..."
              pm2 start ecosystem.config.js --env production
            fi

            # Wait a moment for the app to start
            sleep 5

            # Check if deployment was successful
            echo "ğŸ” Verifying deployment..."
            if curl -f http://localhost:3000/health; then
              echo "âœ… Deployment successful!"
              echo "ğŸŒ Application is running at: http://${{ secrets.EC2_HOST }}"
            else
              echo "âŒ Deployment failed, rolling back..."
              cd ..
              rm -rf AWS-Node
              mv AWS-Node-backup-* AWS-Node
              cd AWS-Node
              if pm2 list | grep -q "Weather-App"; then
                pm2 restart Weather-App
              else
                pm2 start ecosystem.config.js --env production
              fi
              echo "ğŸ”„ Rollback completed"
              exit 1
            fi

            # Show PM2 status
            echo "ğŸ“Š PM2 Status:"
            pm2 status

            # Show recent logs
            echo "ğŸ“‹ Recent logs:"
            pm2 logs Weather-App --lines 10

            # Save PM2 configuration for startup
            pm2 save
            pm2 startup

            echo "ğŸ‰ Deployment completed successfully!"
